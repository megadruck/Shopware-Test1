//{namespace name="backend/viison_shipping_common_order/order"}
Ext.define("Shopware.apps.ViisonShippingCommonOrder.controller.ListDispatch",{ extend:"Ext.app.Controller",snippets:{ messages:{ defaultError:'{s name=list/messages/default_error}{/s}',productMappingMissing:'{s name=list/messages/product_mapping_missing}{/s}'},notifications:{ noTrackingCodesError:{ title:'{s name=detail/notifications/no_tracking_codes_error/title}{/s}',message:'{s name=detail/notifications/no_tracking_codes_error/message}{/s}'}}},init:function(){ var t=this;t.callParent(arguments);t.control({ "order-list-main-window order-list":{ viisonBatchLabelCreation:t.onBatchLabelCreation,viisonShowDetailDispatchServiceProviderTab:t.onShowDetailDispatchServiceProviderTab,viisonTrackShipments:t.onTrackShipments},"order-viison-shipping-common-batch-label-window":{ confirmBatchLabelCreation:t.onConfirmBatchLabelCreation,close:t.onCloseBatchStatusWindow,showJoinedBatchLabels:t.onShowJoinedBatchLabels,showJoinedExportDocuments:t.onShowJoinedExportDocuments}});t.labelStore=Ext.create("Shopware.apps.ViisonShippingCommonOrder.store.ShippingLabel");t.batchStore=Ext.create("Shopware.apps.ViisonShippingCommonOrder.store.BatchLabelStatus")},addListDispatchActionsControllerClass:function(t){ this.listDispatchActionsControllers=this.listDispatchActionsControllers||[];this.listDispatchActionsControllers.push(this.subApplication.getController(t))},addDispatchServiceProviderTabControllerClass:function(t){ this.dispatchServiceProviderTabControllers=this.dispatchServiceProviderTabControllers||[];this.dispatchServiceProviderTabControllers.push(this.subApplication.getController(t))},onBatchLabelCreation:function(t){ this.orderGrid=t;this.orderRecords=t.getSelectionModel().getSelection();this.createBatchStatusWindow(t.orderStatusStore);this.batchStatusWindow.showJoinedLabelsButton.setDisabled(true);this.batchStatusWindow.showJoinedExportDocumentsButton.setDisabled(true)},onConfirmBatchLabelCreation:function(t){ var e=this;Ext.override(Ext.data.proxy.Ajax,{ timeout:6e4});e.batchStatusWindow.loadMask.show();e.batchStatusWindow.showJoinedLabelsButton.setDisabled(false);e.batchStatusWindow.showJoinedExportDocumentsButton.setDisabled(false);var i=0;var o=[];var a=false;var s=e.after(this.orderRecords.length,function(){ e.batchStatusWindow.loadMask.hide();var s=e.batchStatusWindow.listPanel.statusIcons;var r=s[i]+" primary-button-icon-left-middle";e.batchStatusWindow.showJoinedLabelsButton.setIconCls(r);if(a){ e.batchStatusWindow.showJoinedExportDocumentsButton.setIconCls(r)}e.batchStatusWindow.showJoinedExportDocumentsButton.setDisabled(!a);if(o.length==0){ e.batchStatusWindow.showJoinedLabelsButton.disable()}if(t!==100){ Ext.each(o,function(e){ e.set("status",t);e.setDirty()});var n=Ext.create("Shopware.apps.Order.store.Batch");n.add(o);n.sync({ callback:function(t){ e.reloadOrderStore()}})}else{ e.batchStatusWindow.loadMask.hide();e.reloadOrderStore()}Ext.override(Ext.data.proxy.Ajax,{ timeout:3e4})});var r={ };Ext.each(this.orderRecords,function(t){ r[t.get("id")]=t.data.number;var n=null;var c=null;Ext.each(e.listDispatchActionsControllers,function(e){ if(e.hasProductMapping(t)){ n=e.getShippingLabelClass();c=e;return false}});var l=Ext.create("Shopware.apps.ViisonShippingCommonOrder.model.BatchLabelStatus",{ orderId:t.get("id"),orderNumber:r[t.get("id")]});e.batchStore.add(l);if(n==null){ var d=e.snippets.messages.productMappingMissing;l.set("success",false);l.set("message",d);i=1;s();return true}var h=Ext.create(n,{ orderId:t.get("id"),useDetails:false});h.save({ callback:Ext.pass(function(t,r,n){ if(n.success===true&&r.get("creationSuccess")===true){ e.labelStore.add(r);t.setLabel(r);var l=r.get("trackingCode");t.set("trackingCode",l);Ext.each(e.orderRecords,function(t){ if(t.get("id")==r.get("orderId")){ o.push(t);if(r.get("exportDocumentUrl")!=""){ a=true}return false}});Ext.Ajax.request({ url:c.downloadDocumentsURL,method:"GET",params:{ trackingCode:l}})}else{ var d=n.success&&r.get("message")&&r.get("message").length>0?r.get("message"):e.snippets.messages.defaultError;t.set("success",false);t.set("message",d);i=1}s()},l)})})},reloadOrderStore:function(){ var t=this;var e=t.subApplication.getStore("Order");e.reload({ callback:function(){ var i=[];Ext.each(t.orderRecords,function(t){ i.push(e.getById(t.getId()))});t.orderGrid.getSelectionModel().select(i,false,false)}})},onCloseBatchStatusWindow:function(){ if(this.batchStatusWindow){ delete this.batchStatusWindow}},getBatchTrackingCodeParams:function(){ var t=this;var e=[];var i=0;t.labelStore.each(function(t){ if(t.get("trackingCode")==""){ return}e.push("trackingCodes["+i++ +"]="+t.get("trackingCode"))});return e},onShowJoinedBatchLabels:function(){ var t=this;window.open('{url controller="ViisonShippingCommonOrder" action="getMergedLabels"}?'+t.getBatchTrackingCodeParams().join("&"),"mergedPDFResult","scrollbars=yes,menubar=yes,height=600,width=800,resizable=yes,toolbar=yes,status=yes")},onShowJoinedExportDocuments:function(){ var t=this;window.open('{url controller="ViisonShippingCommonOrder" action="getMergedExportDocuments"}?'+t.getBatchTrackingCodeParams().join("&"),"mergedPDFResult","scrollbars=yes,menubar=yes,height=600,width=800,resizable=yes,toolbar=yes,status=yes")},createBatchStatusWindow:function(t){ var e=this;if(e.batchStatusWindow){ e.batchStatusWindow.destroy();delete e.batchStatusWindow}this.batchStore.removeAll();this.labelStore.removeAll();var i=Ext.create("Shopware.apps.Base.store.OrderStatus");i.add(t.getRange());e.batchStatusWindow=Ext.create("Shopware.apps.ViisonShippingCommonOrder.view.BatchLabel.Window",{ labelStore:e.labelStore,batchStore:e.batchStore,orderStatusStore:i,style:{ "background-color":"#ebedef"},bodyStyle:{ "background-color":"#ebedef",border:"none !important"}}).show(undefined,function(){ this.subApplication=e.subApplication})},onShowDetailDispatchServiceProviderTab:function(t){ Ext.each(this.listDispatchActionsControllers,function(e){ if(e.hasProductMapping(t)){ Shopware.app.Application.addSubApplication({ name:"Shopware.apps.Order",params:{ orderId:t.get("id"),focus:e.tabPanelAlias,showLabelConfirmWindow:true}});return false}})},onTrackShipments:function(t){ var e=this;if(t.raw.trackingCode.length==0){ var i=this.snippets.notifications.noTrackingCodesError;Shopware.Notification.createGrowlMessage(i.title,i.message,this.snippets.notifications.growlMessage);return}Ext.each(e.listDispatchActionsControllers,function(e){ if(e.hasTrackingCode(t)){ e.openTrackingWindow(t.raw.trackingCode);return false}})},after:function(t,e){ return function(){ if(--t<1){ return e.apply(this,arguments)}}}});
