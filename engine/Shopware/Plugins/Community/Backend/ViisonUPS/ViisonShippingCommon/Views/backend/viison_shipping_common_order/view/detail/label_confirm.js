//{namespace name="backend/viison_shipping_common_order/order"}
Ext.define("Shopware.apps.ViisonShippingCommonOrder.view.detail.LabelConfirm",{ extend:"Ext.form.Panel",alias:"widget.order-viison-shipping-common-label-confirm-panel",layout:{ align:"stretch",type:"vbox"},flex:1,bodyPadding:"10 10 0 10",border:0,collapsible:false,fieldConstraints:{ packageDimensionsRequired:false},displayPackagingDimensionFields:true,snippets:{ details:{ title:'{s name=label_confirm/details/title}{/s}',labels:{ salutation:{ label:'{s name=label_confirm/details/labels/salutation/label}{/s}',mr:'{s name=label_confirm/details/labels/salutation/salutation_mr}{/s}',ms:'{s name=label_confirm/details/labels/salutation/salutation_ms}{/s}',company:'{s name=label_confirm/details/labels/salutation/salutation_company}{/s}'},saveInOrder:'{s name=label_confirm/details/labels/save_in_order}{/s}',companyAndDepartment:'{s name=label_confirm/details/labels/company_and_department}{/s}',name:'{s name=label_confirm/details/labels/name}{/s}',streetAndNumber:'{s name=label_confirm/details/labels/street_and_number}{/s}',additionalAddressLine:'{s name=label_confirm/details/labels/additional_address_line}{/s}',zipCityAndCountry:'{s name=label_confirm/details/labels/zip_city_and_country}{/s}',phone:'{s name=label_confirm/details/labels/phone}{/s}',email:'{s name=label_confirm/details/labels/email}{/s}'}},packagingDetails:{ title:'{s name=label_confirm/packaging_details/title}{/s}',titleWithoutDimensions:'{s name=label_confirm/packaging_details/title_without_dimensions}{/s}',labels:{ length:'{s name=label_confirm/packaging_details/labels/length}{/s}',width:'{s name=label_confirm/packaging_details/labels/width}{/s}',height:'{s name=label_confirm/packaging_details/labels/height}{/s}',weight:'{s name=label_confirm/packaging_details/labels/weight}{/s}'}},settingsDetails:{ title:'{s name=label_confirm/settings_details/title}{/s}',labels:{ createExportDocument:'{s name=label_confirm/settings_details/labels/create_export_document}{/s}',cashOnDelivery:'{s name=label_confirm/settings_details/labels/cash_on_delivery}{/s}',numberOfLabels:'{s name=label_confirm/settings_details/labels/number_of_labels}{/s}'}},orderAmountInformation:{ title:'{s name=label_confirm/order_amount_information/title}{/s}',labels:{ amount:'{s name=label_confirm/order_amount_information/labels/amount}{/s}',currency:'{s name=label_confirm/order_amount_information/labels/currency}{/s}'}},buttons:{ confirm:'{s name=label_confirm/buttons/confirm}{/s}',cancel:'{s name=label_confirm/buttons/cancel}{/s}'},tooltips:{ cashOnDeliveryHelp:'{s name=label_confirm/tooltips/cash_on_delivery_help}{/s}',itemWeightsComplete:'{s name=label_confirm/tooltips/item_weights_complete}{/s}',itemWeightsIncomplete:'{s name=label_confirm/tooltips/item_weights_incomplete}{/s}',weightManuallyChanged:'{s name=label_confirm/tooltips/weight_manually_changed}{/s}',numberOfLabelsWeightWarning:'{s name=label_confirm/tooltips/number_of_labels_weight_warning}{/s}',saveInOrderHelp:'{s name=label_confirm/tooltips/save_in_order_help}{/s}',createExportDocumentHelp:'{s name=label_confirm/tooltips/create_export_document_help}{/s}',productMappingMissing:'{s name=label_confirm/tooltips/product_mapping_missing}{/s}'},streetValidationFailed:'{s name=label_confirm/street_validation_failed}{/s}',groupValidationFailed:'{s name=label_confirm/group_validation_failed}{/s}'},initComponent:function(){ var e=this;e.salutationData=[["mr",e.snippets.details.labels.salutation.mr],["ms",e.snippets.details.labels.salutation.ms],["company",e.snippets.details.labels.salutation.company]];e.items=e.getItems();e.updateExtraContainersVisibility();e.dockedItems=[e.createButtonsContainer()];if(e.record){ e.fieldConstraints=e.record[e.dispatchServiceProviderPrefix].fieldConstraints;if(e.settingsContainer){ e.numberOfLabels.maxValue=e.maxNumberOfLabels-e.store.count()}e.setValues()}else{ e.countriesStore.load({ callback:function(){ e.detailsContainer.getForm().setValues({ country:e.countriesStore.findRecord("iso","DE").get("id")})}})}e.callParent(arguments);Ext.each(e.query("[group]"),function(i){ i.addListener("change",e.fieldChange)})},createDetailsContainer:function(){ var e=this;e.detailsContainer=Ext.create("Ext.form.Panel",{ cls:"confirm-panel-main",title:e.snippets.details.title,bodyPadding:5,layout:"anchor",defaults:{ anchor:"100%"},items:e.createDetailsFormRows(105,5)});return e.detailsContainer},createDetailsFormRows:function(e,i){ var t=this;var a=[{ xtype:"combobox",flex:2,name:"salutation",valueField:"text",displayField:"snippet",queryMode:"local",mode:"local",editable:false,allowBlank:false,store:Ext.create("Ext.data.SimpleStore",{ fields:["text","snippet"],data:t.salutationData})},Ext.create("Ext.form.field.Display",{ width:100,name:"&nbsp;"})];if(!t.isReturn&&t.record){ a.push(Ext.create("Ext.form.field.Checkbox",{ name:"saveInOrder",fieldLabel:t.snippets.details.labels.saveInOrder,labelStyle:"margin-top: 0px",helpText:t.snippets.tooltips.saveInOrderHelp,labelWidth:140,flex:3,uncheckedValue:false,inputValue:true}))}t.streetName={ xtype:"textfield",flex:6,name:"street",allowBlank:false,maxLength:t.maxLength.streetName,labelConfirmPanel:t,validator:t.streetValidator};t.streetNumber={ xtype:"textfield",flex:1,name:"streetNumber",allowBlank:false,maxLength:t.maxLength.streetNumber,labelConfirmPanel:t,validator:t.streetValidator};t.additionalAddressLine={ xtype:"textfield",flex:1799,name:"additionalAddressLine",allowBlank:true,maxLength:t.maxLength.additionalAddressLine};t.statesStore=Ext.create("Shopware.store.CountryState");t.state=Ext.create("Ext.form.field.ComboBox",{ flex:1280,name:"state",valueField:"id",displayField:"name",queryMode:"local",mode:"local",required:false,editable:false,allowBlank:true,emptyText:"-",store:t.statesStore,listeners:{ change:t.stateChanged,scope:t}});t.country=Ext.create("Ext.form.field.ComboBox",{ flex:5,name:"country",valueField:"id",displayField:"name",queryMode:"local",mode:"local",required:true,editable:false,allowBlank:false,store:t.countriesStore,listeners:{ change:t.countryChanged,scope:t}});return[t.createFormRow({ rowCls:"confirm-panel-row-salutation",label:{ width:e,text:t.snippets.details.labels.salutation.label},items:a}),t.createFormRow({ rowCls:"confirm-panel-row-name",padding:i,label:{ width:e,text:t.snippets.details.labels.name},items:[{ xtype:"textfield",flex:1,name:"firstName",allowBlank:false,maxLength:t.maxLength.firstName,labelConfirmPanel:t,validator:t.nameValidator},{ xtype:"textfield",flex:1,name:"lastName",allowBlank:false,maxLength:t.maxLength.lastName,labelConfirmPanel:t,validator:t.nameValidator}]}),t.createFormRow({ rowCls:"confirm-panel-row-company",padding:i,label:{ width:e,text:t.snippets.details.labels.companyAndDepartment,labelStyle:"margin-top: 0px"},items:[{ xtype:"textfield",flex:1,name:"company",maxLength:t.maxLength.companyName},{ xtype:"textfield",flex:1,name:"department",maxLength:t.maxLength.companyDepartment}]}),t.createFormRow({ rowCls:"confirm-panel-row-street",padding:i,label:{ width:e,text:t.snippets.details.labels.streetAndNumber,labelStyle:"margin-top: 0px"},items:[t.streetName,t.streetNumber]}),t.createFormRow({ padding:i,label:{ width:e,text:t.snippets.details.labels.additionalAddressLine},items:[t.additionalAddressLine,t.state]}),t.createFormRow({ rowCls:"confirm-panel-row-city",padding:i,label:{ width:e,text:t.snippets.details.labels.zipCityAndCountry},items:[{ xtype:"textfield",flex:2,name:"zipCode",allowBlank:false,maxLength:t.maxLength.zip},{ xtype:"textfield",flex:5,name:"city",allowBlank:false,maxLength:t.maxLength.city},t.country]}),t.createFormRow({ rowCls:"confirm-panel-row-phone",padding:i,label:{ width:e,text:t.snippets.details.labels.phone},items:[{ xtype:"textfield",flex:1,name:"phone",allowBlank:true,maxLength:t.maxLength.phoneNumber},Ext.create("Ext.form.field.Display",{ width:i,name:"&nbsp;"}),{ xtype:"textfield",flex:2,name:"email",allowBlank:true,fieldLabel:t.snippets.details.labels.email,labelWidth:40,maxLength:t.maxLength.email}]})]},createPackagingContainer:function(){ var e=this;e.packagingContainer=Ext.create("Ext.form.Panel",{ cls:"confirm-panel-packaging",title:e.displayPackagingDimensionFields?e.snippets.packagingDetails.title:e.snippets.packagingDetails.titleWithoutDimensions,bodyPadding:5,margin:"5 0 0 0",layout:"anchor",defaults:{ anchor:"100%"},items:e.createPackagingFormRows(e.displayPackagingDimensionFields?80:105,10)});return e.packagingContainer},createPackagingFormRows:function(e,i){ var t=this;var a=t.fieldConstraints?!t.fieldConstraints.packageDimensionsRequired:true;t.weightIcon=Ext.create("Ext.menu.Item",{ width:25});var l=[];if(t.displayPackagingDimensionFields){ l.push(t.createFormRow({ rowCls:"confirm-panel-row-packaging-details",label:{ width:e,text:t.snippets.packagingDetails.labels.length},items:[{ xtype:"numberfield",flex:1,name:"packagingLength",allowBlank:a,minValue:0,allowDecimals:false,maxLength:t.maxLength.length,group:"packagingDimensions",validator:t.groupValidator},{ xtype:"displayfield",width:i,name:"&nbsp;"},{ xtype:"numberfield",flex:2,name:"packagingWidth",allowBlank:a,fieldLabel:t.snippets.packagingDetails.labels.width,labelWidth:e,minValue:0,allowDecimals:false,maxLength:t.maxLength.width,group:"packagingDimensions",validator:t.groupValidator},{ xtype:"displayfield",width:i,name:"&nbsp;"},{ xtype:"numberfield",flex:2,name:"packagingHeight",allowBlank:a,fieldLabel:t.snippets.packagingDetails.labels.height,labelWidth:e,minValue:0,allowDecimals:false,maxLength:t.maxLength.length,group:"packagingDimensions",validator:t.groupValidator}]}))}l.push(t.createFormRow({ rowCls:"confirm-panel-row-weight",padding:i,label:{ width:e,text:t.snippets.packagingDetails.labels.weight},items:[{ xtype:"x-custom-field-weight",width:100,maxWidth:100,name:"weight",allowBlank:false,defaultSubmitValue:0,maxLength:t.maxLength.weight,validator:function(e){ if(!isNaN(parseFloat(e.replace(",",".")))){ return true}return this.callParent(arguments)},listeners:{ change:{ fn:t.weightFieldChanged,scope:t}}},t.weightIcon,Ext.create("Ext.form.field.Display",{ name:"&nbsp;",flex:1})]}));return l},createSettingsDetails:function(){ var e=this;e.productComboBox={ xtype:"combobox",flex:1,name:"product",valueField:"id",displayField:"name",queryMode:"local",mode:"local",required:true,editable:false,allowBlank:false,store:e.productStore,listeners:{ change:e.productChanged,scope:e}};e.productIcon=Ext.create("Ext.menu.Item",{ width:25,iconCls:"c-sprite-exclamation",tooltip:e.fillSnippet(e.snippets.tooltips.productMappingMissing),hidden:true});e.numberOfLabels=Ext.create("Ext.form.field.Number",{ name:"numberOfLabels",width:100,maxWidth:100,value:1,minValue:1,listeners:{ change:e.numberOfLabelsFieldChanged,scope:e}});e.numberOfLabelsIcon=Ext.create("Ext.menu.Item",{ width:25,iconCls:"c-sprite-exclamation",tooltip:e.snippets.tooltips.numberOfLabelsWeightWarning,hidden:true});e.createExportDocument=Ext.create("Ext.form.field.Checkbox",{ xtype:"checkbox",name:"createExportDocument",helpText:e.snippets.tooltips.createExportDocumentHelp,fieldLabel:e.snippets.settingsDetails.labels.createExportDocument,labelWidth:150,required:false,checked:false,uncheckedValue:false,inputValue:true,listeners:{ change:e.createExportDocumentChanged,scope:e}});e.cashOnDelivery=Ext.create("Ext.form.field.Checkbox",{ xtype:"checkbox",name:"cashOnDelivery",checked:false,uncheckedValue:false,inputValue:true,helpText:e.fillSnippet(e.snippets.tooltips.cashOnDeliveryHelp),fieldLabel:e.snippets.settingsDetails.labels.cashOnDelivery,labelWidth:69,listeners:{ change:e.cashOnDeliveryChanged,scope:e}});e.settingsContainer=Ext.create("Ext.form.Panel",{ cls:"confirm-panel-label-type",title:e.snippets.settingsDetails.title,bodyPadding:5,margin:"5 0 0 0",layout:"anchor",defaults:{ anchor:"100%"},items:e.createSettingsFormRows(105,10)});return e.settingsContainer},createFormRow:function(e){ var i=[];var t=e.label;if(t!==undefined){ i.push(Ext.create("Ext.form.field.Display",{ width:t.width,fieldLabel:t.text,labelStyle:t.labelStyle?t.labelStyle:"",submitValue:false}))}var a=e.items;var l=e.padding;for(var n=0;n<a.length;n++){ i.push(a[n]);if(l!==undefined&&n<a.length-1){ i.push(Ext.create("Ext.form.field.Display",{ width:l,name:"&nbsp;"}))}}return Ext.create("Ext.container.Container",{ layout:"hbox",align:"stretch",margin:"5 0",cls:e.rowCls,hidden:e.hidden!==undefined?e.hidden:false,items:i})},createButtonsContainer:function(){ var e=this;return Ext.create("Ext.toolbar.Toolbar",{ dock:"bottom",ui:"footer",border:false,shadow:false,padding:"10 0 5 0",style:{ "background-color":"transparent","box-shadow":"none","-moz-box-shadow":"none","-webkit-box-shadow":"none","-o-box-shadow":"none"},items:[{ xtype:"tbfill"},Ext.create("Ext.button.Button",{ cls:"secondary",text:e.snippets.buttons.cancel,handler:function(){ var i=e.up("order-viison-shipping-common-label-confirm-window");e.fireEvent("destroyLabelConfirmWindow",i)}}),Ext.create("Ext.button.Button",{ cls:"primary",text:e.snippets.buttons.confirm,handler:e.confirmButtonClicked,scope:e})]})},setValues:function(){ var e=this;if(!e.record){ return}var i=e.record;var t=i[e.dispatchServiceProviderPrefix].calculatedShipmentWeight?i[e.dispatchServiceProviderPrefix].calculatedShipmentWeight.weight:null;e.updateWeightIcon();var a=i.getShipping().first();var l=i.getBilling().first();var n=i.getCustomer().first();e.detailsContainer.getForm().setValues({ salutation:a.get("salutation"),firstName:a.get("firstName"),lastName:a.get("lastName"),street:i[e.dispatchServiceProviderPrefix].splittedAddress.streetName,streetNumber:i[e.dispatchServiceProviderPrefix].splittedAddress.houseNumber,additionalAddressLine:i[e.dispatchServiceProviderPrefix].splittedAddress.additionalAddressLine,zipCode:a.get("zipCode"),city:a.get("city"),state:a.get("stateId"),country:a.get("countryId"),company:a.get("company"),department:a.get("department"),phone:l.get("phone"),email:n.get("email")});if(e.statesStore.getCount()>0&&!e.statesStore.getById(e.state.getValue())){ e.state.setValue(null)}if(e.packagingContainer){ e.packagingContainer.getForm().setValues({ packagingLength:i[e.dispatchServiceProviderPrefix].defaultPackageLength,packagingHeight:i[e.dispatchServiceProviderPrefix].defaultPackageHeight,weight:t,packagingWidth:i[e.dispatchServiceProviderPrefix].defaultPackageWidth})}if(e.settingsContainer){ e.settingsContainer.getForm().setValues({ product:i[e.dispatchServiceProviderPrefix].product,createExportDocument:i[e.dispatchServiceProviderPrefix].exportDocumentRequired,cashOnDelivery:e.record[e.dispatchServiceProviderPrefix].isCashOnDelivery})}if(e.orderAmountInformation){ e.orderAmountInformation.getForm().setValues({ amount:i.get("invoiceAmount"),currency:i.get("currency")})}e.updateProductIcon()},updateConstraints:function(){ var e=this;if(e.record){ e.fieldConstraints=e.record[e.dispatchServiceProviderPrefix].fieldConstraints}if(!e.fieldConstraints||!e.packagingContainer){ return}var i=e.packagingContainer.items.items[0].items.items;for(var t=0;t<i.length;t++){ if(i[t].name&&i[t].name.indexOf("packaging")===0){ i[t].allowBlank=!e.fieldConstraints.packageDimensionsRequired}}},updateWeightIcon:function(){ var e=this;if(!e.weightIcon){ return}if(e.record&&e.record[e.dispatchServiceProviderPrefix].calculatedShipmentWeight){ var i=e.record[e.dispatchServiceProviderPrefix].calculatedShipmentWeight.complete===true?"c-sprite-tick":"c-sprite-exclamation";var t=e.record[e.dispatchServiceProviderPrefix].calculatedShipmentWeight.complete===true?e.snippets.tooltips.itemWeightsComplete:e.snippets.tooltips.itemWeightsIncomplete;e.weightIcon.setIconCls(i);e.weightIcon.setVisible(true);e.weightIcon.setTooltip(t)}if(!e.record||!e.record[e.dispatchServiceProviderPrefix].calculatedShipmentWeight||e.record[e.dispatchServiceProviderPrefix].calculatedShipmentWeight.isDefault){ e.weightIcon.setVisible(false);e.weightIcon.setTooltip("")}},updateProductIcon:function(){ var e=this;if(!e.productIcon){ return}var i=e.record&&e.record[e.dispatchServiceProviderPrefix].product!=null;e.productIcon.setVisible(!i)},weightFieldChanged:function(e,i,t){ var a=this;if(!a.record||!a.record[a.dispatchServiceProviderPrefix].calculatedShipmentWeight.weight||a.record[a.dispatchServiceProviderPrefix].calculatedShipmentWeight.isDefault||i==t){ return}if(e.getSubmitValue()!=a.record[a.dispatchServiceProviderPrefix].calculatedShipmentWeight.weight){ a.weightIcon.setIconCls("c-sprite-exclamation");a.weightIcon.setVisible(true);a.weightIcon.setTooltip(a.snippets.tooltips.weightManuallyChanged)}else{ a.updateWeightIcon()}},numberOfLabelsFieldChanged:function(e,i){ if(i>1){ this.numberOfLabelsIcon.setVisible(true)}else{ this.numberOfLabelsIcon.setVisible(false)}},productChanged:function(e,i){ var t=this;var a=t.productStore.findRecord("id",i,false,false,false,true);t.fieldConstraints.packageDimensionsRequired=a.get("packageDimensionsRequired");t.updateConstraints()},countryChanged:function(e,i,t){ var a=this;a.statesStore.getProxy().extraParams={ countryId:i};a.statesStore.load({ callback:function(){ if(a.statesStore.getCount()===0){ a.state.setValue(null);a.state.hide();return true}a.statesStore.insert(0,{ id:null,name:"-"});if(i!=t){ a.state.setValue(null)}a.state.show()}})},stateChanged:function(e,i){ },nameValidator:function(e){ var i=this;var t=i.labelConfirmPanel;if(!t.maxLength.name){ return true}var a=i.up('[cls="confirm-panel-row-name"]');var l=a.down('[name="firstName"]');var n=a.down('[name="lastName"]');var r=(l.getValue()+" "+n.getValue()).length<=t.maxLength.name;if(r){ if(i!=l){ l.clearInvalid()}else if(i!=n){ n.clearInvalid()}return true}else{ var s=Ext.String.format(t.snippets.streetValidationFailed,t.maxLength.name);if(i!=l){ l.markInvalid(s)}else if(i!=n){ n.markInvalid(s)}return s}},streetValidator:function(e){ var i=this;var t=i.labelConfirmPanel;if(!t.maxLength.street){ return true}var a=i.up('[cls="confirm-panel-row-street"]');var l=a.down('[name="street"]');var n=a.down('[name="streetNumber"]');var r=(l.getValue()+" "+n.getValue()).length<=t.maxLength.street;if(r){ if(i!=l){ l.clearInvalid()}else if(i!=n){ n.clearInvalid()}return true}else{ var s=Ext.String.format(t.snippets.streetValidationFailed,t.maxLength.street);if(i!=l){ l.markInvalid(s)}else if(i!=n){ n.markInvalid(s)}return s}},confirmButtonClicked:function(e){ this.createLabels()},createLabels:function(e){ var i=this;var t=i.up("order-viison-shipping-common-label-confirm-window");var a=i.detailsContainer.getForm().getValues();var l=i.packagingContainer?i.packagingContainer.getForm().getValues():null;var n=i.settingsContainer?i.settingsContainer.getForm().getValues():null;var e=i.isReturn?{ }:Ext.apply(i.getExtraSettings(),e);var r=i.isReturn?"createReturnLabel":"createShippingLabel";i.fireEvent(r,i.dispatchServiceProviderTab,i.record,a,l,n,e,t)},createOrderAmountInformation:function(){ var e=this;e.orderAmountInformation=Ext.create("Ext.form.Panel",{ cls:"confirm-panel-label-type",title:e.snippets.orderAmountInformation.title,bodyPadding:5,margin:"5 0 0 0",layout:"anchor",defaults:{ anchor:"100%"},items:e.createOrderAmountInformationFormRows(105,10)});return e.orderAmountInformation},createOrderAmountInformationFormRows:function(e,i){ var t=this;return[t.createFormRow({ padding:i,label:{ width:e,text:t.snippets.orderAmountInformation.labels.amount,labelStyle:"margin-top: 0px"},items:[{ xtype:"numberfield",decimalPrecision:2,submitLocaleSeparator:false,name:"amount",flex:2,allowBlank:false},{ xtype:"textfield",name:"currency",fieldLabel:t.snippets.orderAmountInformation.labels.currency,labelWidth:65,value:"EUR",flex:1,allowBlank:false}]})]},fillSnippet:function(e){ return Ext.String.format(e,this.dispatchServiceProviderName)},fieldChange:function(e,i,t,a){ if(e.group){ var l=e.up("form").query('[group="'+e.group+'"]');Ext.each(l,function(i){ if(i.name===e.name){ return}i.validate()})}},groupHasNonBlankValues:function(e,i){ var t=this;var a=e.query('[group="'+i+'"]');var l=false;Ext.each(a,function(e){ if(!t.isFieldBlank(e)){ l=true;return false}});return l},isFieldBlank:function(e){ return e.getValue()===null||e.getValue()===""||e.emptyText&&e.getValue()===e.emptyText},groupValidator:function(e){ var i=this;var t=i.up("order-viison-shipping-common-label-confirm-panel");if(!t){ return true}var a=i.up("form");var l=!t.groupHasNonBlankValues(a,i.group,i.shopId);if(!t.isFieldBlank(i)||i.optionalGroupField||l){ return true}else{ return t.snippets.groupValidationFailed}},createExportDocumentChanged:function(e,i){ },cashOnDeliveryChanged:function(e,i){ this.updateExtraContainersVisibility()},updateExtraContainersVisibility:function(){ var e=this;if(e.isReturn){ return}var i=e.cashOnDelivery.getValue();e.orderAmountInformation.setVisible(i);if(i){ e.orderAmountInformation.enable()}else{ e.orderAmountInformation.disable()}},createExtraContainers:function(){ return[this.createOrderAmountInformation()]},createExtraSettingsFormRows:function(){ return[]},getExtraSettings:function(){ return this.orderAmountInformation.getForm().getValues()}});
