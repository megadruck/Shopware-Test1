//{namespace name=backend/viison_shipping_common_config/config}
Ext.define("Shopware.apps.ViisonShippingCommonConfig.controller.Main",{ extend:"Ext.app.Controller",init:function(){ var i=this;var e=i.getView("Window").create();e.show();i.getWindow().loadMask.show();i.updateShopStore();i.initKeyMap();i.control({ "viison-shipping-common-config-window button[action=save]":{ click:function(e,t){ i.onSave()}},"viison-shipping-common-config-window button[action=reset]":{ click:function(e,t){ i.onLoad()}}})},initKeyMap:function(){ this.map=new Ext.util.KeyMap(this.getWindow().getEl(),[{ key:"s",ctrl:true,handler:this.onKeyHandler,scope:this,defaultEventAction:"preventDefault"}])},onKeyHandler:function(i,e){ switch(i){ case 83:this.onSave();break}},updateShopStore:function(){ var i=this;i.shopStore=Ext.create("Shopware.apps.ViisonShippingCommonConfig.store.ShopLanguage");i.shopStore.load({ callback:function(e,t,o){ if(!o){ var n=i.snippets.notifications.loadAllConfigurationsError;Shopware.Notification.createGrowlMessage(n.title,n.message,i.snippets.notifications.growlMessage)}else{ i.getPanel().initForm(i.shopStore);i.updateConfigStore()}}})},onLoad:function(){ var i=this;i.shopStore.each(function(e){ var t=i.configStore.find("shopId",e.data.id);if(t>=0){ var o=i.configStore.getAt(t);i.record=o;var n={ };Ext.iterate(o.data,function(i,t){ if(i=="id"){ return true}n["values["+e.getId()+"]["+i+"]"]=t});i.getPanel().getForm().setValues(n)}});i.getWindow().loadMask.hide()},onSave:function(){ var e=this;var t=e.getPanel();var o=t.getForm();if(!o.isValid()){ var n=t.getForm().getFields().items;var a=[];for(i=0;i<n.length;i++){ var s=n[i];if(!s.disabled&&!s.isValid()){ t.down("tabpanel").setActiveTab(s.up("config-fieldset"));s.el.scrollIntoView(e.getWindow().el.child(".x-window-body"));break}}var r=e.snippets.notifications.saveConfigurationValidationError;Shopware.Notification.createGrowlMessage(r.title,r.message,e.snippets.notifications.growlMessage);return}var c=0,l=0;e.shopStore.each(function(i){ var t=e.configStore.find("shopId",i.data.id);var n;if(t>=0){ n=e.configStore.getAt(t)}else{ n=Ext.create(e.dispatchServiceProviderConfigModelClass,{ shopId:i.data.id});e.configStore.add(n)}var a=n.fields.items;Ext.each(a,function(e){ var t="values["+i.getId()+"]["+e.name+"]";var a=o.findField(t);if(!a){ return true}var s=a.getSubmitValue();if(typeof s=="string"){ s=s.trim()}n.set(e.name,s)});n.save({ callback:function(i,t){ c++;if(t.success){ l++}if(c==e.shopStore.getCount()){ var o=l==e.shopStore.getCount()?e.snippets.notifications.saveConfigurationSuccess:e.snippets.notifications.saveConfigurationError;Shopware.Notification.createGrowlMessage(o.title,o.message,e.snippets.notifications.growlMessage);e.updateConfigStore()}}})})},updateConfigStore:function(){ var i=this;i.configStore.load({ callback:function(e,t,o){ if(!o){ var n=i.snippets.notifications.loadAllConfigurationsError;Shopware.Notification.createGrowlMessage(n.title,n.message,i.snippets.notifications.growlMessage)}else{ i.onLoad()}}})}});
